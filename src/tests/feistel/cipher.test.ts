import { afterEach, describe, expect, jest, test } from "@jest/globals";
import { processText } from "../../ts/feistel/cipher";
import { decryptRound, encryptRound } from "../../ts/feistel/round_funcs.ts";

describe("Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½ÐµÐ¿Ð¾ÑÑ€ÐµÐ´ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ ÑˆÐ¸Ñ„Ñ€Ð° Ð¤ÐµÐ¹ÑÑ‚ÐµÐ»Ñ", () => {
    afterEach(() => {
        jest.resetAllMocks();
    });

    describe("encryptRound", () => {
        test.each([
            [[0n, 0n, 0n, 0n], 0n, [0n, 0n, 0n, 0n]],
            [[0n, 0n, 0n, 0n], 1n, [1n, 1n, 1n, 0n]],
            [[0b110n, 0b10n, 0b11n, 0b1001n], 0b1001n, [0b1101n, 0b1100n, 0b110n, 0b110n]],
            [[0b1101n, 0b101n, 0b1001n, 0b10111n], 0b100n, [0b1100n, 0n, 0b11110n, 0b1101n]],
        ])(
            "Ð•ÑÐ»Ð¸ Ð½Ð° Ð²Ñ…Ð¾Ð´ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°ÑŽÑ‚ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¸, Ñ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÑˆÐ¸Ð²Ð°Ð½Ð¸Ðµ",
            (threads: bigint[], key: bigint, expected: readonly bigint[]) => {
                const result = encryptRound(threads, key);
                expect(result).toStrictEqual(expected);
            },
        );
    });

    describe("decryptRound", () => {
        test.each([
            [[0n, 0n, 0n, 0n], 0n, [0n, 0n, 0n, 0n]],
            [[1n, 1n, 1n, 0n], 1n, [0n, 0n, 0n, 0n]],
            [[0b1101n, 0b1100n, 0b110n, 0b110n], 0b1001n, [0b110n, 0b10n, 0b11n, 0b1001n]],
            [[0b1100n, 0n, 0b11110n, 0b1101n], 0b100n, [0b1101n, 0b101n, 0b1001n, 0b10111n]],
        ])(
            "Ð•ÑÐ»Ð¸ Ð½Ð° Ð²Ñ…Ð¾Ð´ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°ÑŽÑ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÑˆÐ°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¸, Ñ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ",
            (threads: bigint[], key: bigint, expected: readonly bigint[]) => {
                const result = decryptRound(threads, key);
                expect(result).toStrictEqual(expected);
            },
        );
    });

    describe("processText", () => {
        test.each([
            ["Test", Array(8).fill(0n)],
            ["Ð¢ÐµÑÑ‚", Array(8).fill(5n)],
            ["Ð¢ÐµÑÑ‚Ð‘ÐµÐ·ÐŸÑ€Ð¾Ð±ÐµÐ»Ð°Ð¡ÐÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼Ð¸Ð‘Ð»Ð¾ÐºÐ°Ð¼Ð¸Ð˜ÐšÐ»ÑŽÑ‡Ð°Ð¼Ð¸", [4n, 23n, 8n, 5n, 7n, 1n, 0n, 7n]],
            ["Test$", Array(8).fill(0n)],
            ["ÐÐ°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾ Ð¼Ð¾Ñ Ð¿Ñ€ÐµÐ»ÐµÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð½Ñƒ Ð²Ñ‹ Ð½Ðµ Ð¿Ð¾Ð²ÐµÑ€Ð¸Ñ‚Ðµ", [5n, 3n, 11n, 15n, 7n, 0n, 10n, 17n]],
            ["ÐÐ°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾ Ð¼Ð¾Ñ Ð¿Ñ€ÐµÐ»ÐµÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð½Ñƒ Ð²Ñ‹ Ð½Ðµ Ð¿Ð¾Ð²ÐµÑ€Ð¸Ñ‚Ðµ", Array(8).fill(0n)],
            [
                "ÐÐ™ ÐœÐ˜Ð¨ÐÐÐ¯ðŸ”¥ðŸ”¥ðŸ’ª Ð§Ð˜Ð¡Ð¢Ðž Ð’ ÐšÐžÐÐ”Ð˜Ð¦Ð˜Ð˜ Ð’ÐžÐ¨Ð•Ð›ðŸ¦ðŸ¦ðŸ¦â˜ï¸ÐÐ™ Ð›Ð•Ð’ Ð“Ð›ÐÐ’ÐÐžÐ• Ð’ÐžÐ¨ÐÐ› Ð¢Ð˜Ð¥Ðž Ð˜ ÐÐšÐšÐ£Ð ÐÐ¢ÐÐ•ÐÐ¬ÐšÐž ðŸ”¥ðŸ”¥ðŸ”¥â˜ï¸â˜ï¸ÐšÐ ÐÐ¡ÐÐ’Ð§Ð˜Ðš Ð”Ð’Ð˜Ð“ÐÐ•Ð¨Ð¬Ð¡Ð¯ Ð ÐžÐ’ÐÐ«ÐœÐ˜ Ð”Ð’Ð˜Ð–Ð•ÐÐ˜Ð¯ÐœÐ˜ ÐÐ™ Ð¥ÐžÐ ÐžÐ¨ðŸ˜ˆðŸ˜ˆðŸ’ªðŸ’ªðŸ’ªâ˜ï¸ðŸ”¥ðŸ¦ðŸ¦ Ð¡ÐÐÐ•Ð§ÐšÐ Ð’ÐžÐ¢Ð•Ð¢Ð Ð¡Ð£Ð•Ð¢Ð\n" +
                    "\n" +
                    "Ð°Ð¹ ÐºÑ€Ð°ÑÐ°Ð²Ñ‡Ð¸Ðº Ð»Ð¸Ñ‚Ð²Ð¸Ð½Ñ‡Ð¸Ðº ðŸ˜ˆðŸ˜ˆðŸ˜ˆðŸ’ªðŸ’ªðŸ”¥ Ð½Ð° ÐºÐ°Ð½Ð´Ð¸Ñ†Ð¸ÑÑ… ÑÑƒÐµÑ‚Ð° Ñ€Ð¾Ð´Ð½Ð°Ñ Ð¿Ð¾Ð»ÐµÑ‚ÐµÐ»Ð°ðŸ’ªðŸ¼ðŸ˜ˆðŸ˜ˆ Ð² Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð°Ð¹ÑÐ¹ ðŸ’ªðŸ’ªðŸ’ªðŸ˜ˆðŸ˜ˆðŸ”¥ Ð° Ð³Ð»Ð°Ð²Ð½Ð°Ñ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½ÐµÐ½ÑŒÐºÐ¾ Ð´Ð²Ð¸Ð³Ð°ÐµÑ‚ÑÑ ðŸ”¥ðŸ”¥ðŸ”¥ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð¼ÐµÐ¶Ð³Ð°Ð»Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð±Ñ€Ð°Ñ‚ÐºÐ°ðŸ˜ˆðŸ˜ˆðŸ˜ˆ\n" +
                    "\n" +
                    "ÐÐ¹ Ð°Ð¹ Ð°Ð¹ðŸ”¥ðŸ”¥ðŸ”¥ ÐžÐ±ÐµÐ·ÑŒÑÐ½Ð° Ñ‡Ð¸ÑÑ‚Ð¾ Ð½Ð° ÐºÐ¾Ð½Ð´Ð¸Ñ†Ð¸ÑÑ… ÑÑƒÐµÑ‚Ñƒ Ð½Ð°Ð²Ð¾Ð´Ð¸Ñ‚ðŸ˜‚ðŸ˜‚ðŸ˜‚\n" +
                    "Ð§Ð¸ÑÑ‚Ð¾ ÐºÑ€Ð¾ÑÐ°Ð²Ð° Ð¾Ð±ÐµÐ·ÑŒÑÐ½Ð° Ñ€Ð¾Ð²Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ†Ð°Ð½\n" +
                    "\n" +
                    "Ð§Ð¾ Ð·Ð° Ð¼ÐµÐ¶ÐºÐ¾Ð½Ñ‚Ð¸Ð½ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð±Ñ€Ð°Ñ‚Ð¸ÑˆÐºÐ° ðŸ¥·ðŸ¥·ðŸ¥·â˜ï¸â˜ï¸â˜ï¸Ðº ÐºÐ°ÐºÐ¸Ðµ ÐºÐ¾Ð½Ð´Ð¸Ñ†Ð¸Ð¸ Ð¼Ð¾Ñ‰Ð½Ñ‹Ðµ Ð¸ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ð² ÐºÐ¾Ð½Ñ†Ðµ Ð½Ð°Ð±Ñ€Ð°Ð» ðŸ˜¹ðŸ˜¹ðŸ‘ŠðŸ‘ŠðŸ‘ŠðŸ”¥ðŸ”¥ðŸ”¥ Ð±Ñ€Ð°Ñ‚Ð¸ÑˆÐºÐ°\n" +
                    "\n" +
                    "ÐÐ¹ ÐœÐ¸ÑˆÐ°Ð½Ñ Ñ€Ð¾Ð´Ð½Ð¾Ð¹ ÑÑƒÐµÑ‚Ñ‹ Ñ€Ð°Ð·Ð´Ð°Ð» ÐºÐ°ÐºðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ÑÐ»Ð¸ÐºÑÐ¸Ñ€Ð° Ð·Ð°Ñ…Ð»ÐµÐ±Ð½ÑƒÐ» Ð¸ ÐºÐ¾Ð½Ð´Ð¸Ñ†Ð¸Ð¹ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½ÐµÐ½ÑŒÐºÐ¾ Ð½Ð°Ð±Ñ€Ð°Ð» Ð² Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ÐµðŸ”¥ðŸ”¥ðŸ’ªðŸ’ªâ˜ï¸Ð±Ñ€Ð°Ñ‚ÐºÐ° Ð½Ð¸ Ð´Ð½Ñ Ð±ÐµÐ· ÑÑƒÐµÑ‚Ñ‹ðŸ˜ŽðŸ˜ŽðŸ”¥",
                Array(8).fill(0n),
            ],
        ])("Ð•ÑÐ»Ð¸ Ð½Ð° Ð²Ñ…Ð¾Ð´ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°ÐµÑ‚ Ñ‚ÐµÐºÑÑ‚, Ñ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½ÑƒÑŽ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÑƒ", (text: string, keys: bigint[]) => {
            const encrypted = processText("encrypt", text, keys);
            const decrypted = processText("decrypt", encrypted, keys);
            expect(decrypted.trimStart()).toBe(text);
        });
    });
});
